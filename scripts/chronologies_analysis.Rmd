---
title: "New Chronologies Workflow"
---
New workflow as of April 2024.

Takes new_chronologies and new_caldates output from Pinnacles; scp into local directory: 
>scp vsyverson@login.rc.ucmerced.edu:data/new_chronologies.csv new_chronologies.csv
>scp vsyverson@login.rc.ucmerced.edu:data/new_chronologies.csv new_chronologies_long.csv

```{r}
#connect to Postgres; load functions
require(here); i_am("workflow/scripts/chronologies_analysis.Rmd")
source(here("workflow/scripts/postgresConnect.R"))
source(here("workflow/scripts/functions.R"))
```

Load new sample age ranges (analysis unit age limits):
```{r}
names <- data.frame(collid = gsub(".csv","",dir(here("workflow/outputs/sampleages"))),
                    path = unname(sapply(dir(here("workflow/outputs/sampleages")),
                       function(x) paste(c(here("workflow/outputs/sampleages"),"/",x), 
                                         collapse = ""))))
require(rlist)
newchron.all <- list.stack(apply(names,1,function(x) {
  return(suppressWarnings(cbind(collid = as.numeric(x["collid"]),
                                read.csv(x["path"]))))}),use.names = F)
colnames(newchron.all)[1] <- "collectionunitid"
```

Load individual dates (chroncontrols):
```{r}
names2 <- data.frame(collid = gsub(".csv","",dir(here("workflow/outputs/chroncontrols"))),
                    path = unname(sapply(dir(here("workflow/outputs/chroncontrols")),
                       function(x) paste(c(here("workflow/outputs/chroncontrols"),"/",x), 
                                         collapse = ""))))
newchron.ctrls <- list.stack(apply(names2,1,function(x) {
  return(suppressWarnings(cbind(collid = x["collid"],
                                read.csv(x["path"]))))}),use.names = F)
colnames(newchron.ctrls)[1] <- "collectionunitid"
```

Assign types to chronology controls
```{r}
chroncontroltypes <- get_table("chroncontroltypes")
temp <- left_join(newchron.ctrls,alldates[,c("geochronid","geochrontypeid","agetypeid")])
table(temp$geochrontypeid)
typeindex <- data.frame(table(temp$geochrontypeid))
#add more types if necessary here!
typeindex$chroncontroltype <- c("Other dating methods","Palaeomagnetic",
                                "Argon-argon","Radiocarbon","Other dating methods",
                                "Thermoluminescence","Uranium-series") 
typeindex <- left_join(typeindex[c("Var1","chroncontroltype")],chroncontroltypes[,1:4])
temp <- left_join(temp,typeindex[,c("Var1","chroncontroltype","chroncontroltypeid")],
                  by = join_by(geochrontypeid == Var1))
temp[which(temp$geochrontypeid == "Carbon-14" & temp$agetypeid %in% c("calendar yr BP","cal yr BP")),"chroncontroltype"] <- "Radiocarbon, calibrated"
temp[which(temp$geochrontypeid == "Carbon-14" & temp$agetypeid %in% c("calendar yr BP","cal yr BP")),"chroncontroltypeid"] <- 17
newchron.ctrls <- temp[,c(colnames(newchron.ctrls),"chroncontroltypeid")]
```

Generate chronologies table:
```{r}
require(rlist)
getbounds <- function(y) {return(c(max(y["sampleages.ageolder"]),min(y["sampleages.ageyounger"])))}
newchron.range <- list.stack(tapply(newchron.all,newchron.all$collectionunitid,function(x) {
  temp <- data.frame(do.call(cbind, tapply(x,x$chronology.agemodel,getbounds)))
  data.frame(t(temp), colnames(temp),
             collectionunitid = x$collectionunitid[1])
}, simplify = F))
newchron.range <- data.frame(collectionunitid = newchron.range$collectionunitid,
                             agemodel = newchron.range$colnames.temp.,
                             ageboundolder = newchron.range$X1,
                             ageboundyounger = newchron.range$X2)
timeinfo <- cbind(filename = dir(here("workflow/outputs/sampleages")),list.stack(sapply(dir(here("workflow/outputs/sampleages"),full.names = T), file.info, simplify = F)))
timeinfo$collectionunitid <- unlist(sapply(timeinfo$filename,function(x) strsplit(x,".csv")))
timeinfo$dateprepared <- unlist(sapply(timeinfo$mtime,function(x) strsplit(as.character(x)," ")[[1]][1]))
newchron.range <- merge(newchron.range,timeinfo[,c("collectionunitid","dateprepared")])
```

Assign temporary chronology ids to the chronology ranges:
```{r}
#assign temporary chronids
require(dplyr); require(rlist)
newchron.range$TEMP_chronid <- paste0("TEMP",1:nrow(newchron.range))
```

Propagate the temporary chronology ids to the sample ages table:
```{r}
newchron.all <- left_join(newchron.all,
                          newchron.range[,c("collectionunitid","agemodel","TEMP_chronid")],
                          by = join_by(collectionunitid == collectionunitid,
                                       chronology.agemodel == agemodel), 
                          relationship = "many-to-one")
```

Propagate the temporary chronology ids to the chron controls table:
```{r}
#and to newchron.ctrls
newchron.ctrls <- left_join(newchron.ctrls,alldates[,c("geochronid","analysisunitid")],
                            relationship = "many-to-many")
temp <- list(bounds = newchron.ctrls, event = newchron.ctrls)
temp$bounds <- left_join(temp$bounds,subset(newchron.all,newchron.all$chronology.agemodel == "bounds")[,c("analysisunitid","TEMP_chronid")],relationship = "many-to-many")
temp$event <- left_join(temp$event,subset(newchron.all,newchron.all$chronology.agemodel == "event")[,c("analysisunitid","TEMP_chronid")],relationship = "many-to-many")
newchron.ctrls <- list.stack(temp)
```

Save everything:
```{r}
write.csv(newchron.ctrls,"../outputs/new_caldates.csv", row.names = F)
write.csv(newchron.range,"../outputs/new_chronologies.csv", row.names = F)
write.csv(newchron.all,"../outputs/new_sampleages.csv", row.names = F)
```


```{r}
data.frame(Pleistocene = c(nrow(subset(newchron.all,newchron.all$chronology.agemodel == "bounds" & newchron.all$sampleages.ageyounger >= 14500)),
              nrow(subset(newchron.all,newchron.ctrls$chroncontrols.agelimityounger >= 14500))),
           Deglacial = c(nrow(subset(newchron.all,newchron.all$chronology.agemodel == "bounds" & newchron.all$sampleages.ageolder < 14500 & newchron.all$sampleages.ageyounger >= 11700)),
              nrow(subset(newchron.all,newchron.ctrls$chroncontrols.agelimityounger >= 11700 & newchron.ctrls$chroncontrols.agelimitolder < 14500))),
           Holocene = c(nrow(subset(newchron.all,newchron.all$chronology.agemodel == "bounds" & newchron.all$sampleages.ageolder < 11700)),
              nrow(subset(newchron.all,newchron.ctrls$chroncontrols.agelimitolder < 11700))),
           row.names=c("chronologies","dates"))
```

Deal with failed chronologies one by one
```{r}
failed <- unique(subset(alldates$collectionunitid, !alldates$collectionunitid %in% names$collid))
i <- i + 1;subset(alldates,alldates$collectionunitid == failed[i])
table(subset(alldates,alldates$collectionunitid == failed[i])$analysisunitid)

plot(multi.colls[[which(names(multi.colls) == failed[i])]][,c("auorder","age")])
multi.colls[which(names(multi.colls) == failed[i])] -> data
result <- dateranges.multi(data, ordered = T)
write.csv(result$sampleages,here("workflow/outputs/sampleages",
                                 paste0(names(data),".csv",collapse = "")),row.names = F)
write.csv(result$chroncontrols,here("workflow/outputs/chroncontrols",
                                    paste0(names(data),".csv",collapse = "")),row.names = F)

result <- dateranges(failed[i],data = alldates)
write.csv(result$sampleages,here("workflow/outputs/sampleages",
                                 paste0(failed[i],".csv",collapse = "")),row.names = F)
write.csv(result$chroncontrols,here("workflow/outputs/chroncontrols",
                                    paste0(failed[i],".csv",collapse = "")),row.names = F)

split(fail.data,fail.data$collectionunitid) -> rerun.multi
for (i in 1:length(rerun.multi)){
  code <- makeOxcalCode(rerun.multi[[i]])
  write(code, file = paste0(c("../scripts/oxcode",names(rerun.multi[i]),".txt"),collapse=""))
}

dbGetQuery(conn,"select * from collectionunits where siteid = 4865;")
```

figures for paper: (keep color coding of different estimate types)
point 1: we added a bunch of dates (and we could keep going!)
- dates added (highlight areas of sparse data: someone go get the ones from Mexico please!)
-- map of old/new/updated sites
-- plot and/or table of regional representation in data set (lat/long, cal 14C age, old/new)
--- pie chart? stacked histogram?
--- heatmap of % updated dates? (by what partitioning? map grid? ecoregion e.g. Olson or EPA?)
- ?sites with directly dated small mammal specimens
point 2: there are calibrated age estimates now
- conceptual figure e.g. slide 20 of NAPC presentation
- figure describing different types of age estimate e.g. slide 24 (use Crystal Ball Cave or Lindenmeier?)
point 3: we have quantitatively estimated the uncertainties & they are Large
- effect of new chronologies compared to old ones
-- calibrated chronologies
-- quantified uncertainty: (inevitably) increases age ranges (slide 29 NAPC, but broken out by Pleistocene vs Holocene median estimates; or divide Holocene at conventional point)
- ?map of age ranges: best, worst, overall (dichromatic -- data density vs age precision? e.g. 'map of ignorance')
- ?map of median site age
```{r}
require(ggplot2)
temp <- data.frame(range = subset(newchron.all, newchron.all$chronology.agemodel == "bounds")[,"sampleages.ageolder"] - subset(newchron.all, newchron.all$chronology.agemodel == "bounds")[,"sampleages.ageyounger"])
errhist <- ggplot(temp,aes(x = range)) + geom_histogram()
errhist
```


```{r}
alldates <- read.csv(here("workflow/data/alldates.csv"))
nrow(subset(alldates,geochrons$rejected == T))
nrow(subset(alldates,geochrons$infinite == T))
nrow(subset(alldates,apply(alldates[,c("age","errorolder","erroryounger")],1,function(x) any(is.na(x)))))

nrow(subset(alldates,alldates$rejected == T | alldates$infinite == T |
             apply(alldates[,c("age","errorolder","erroryounger")],1,function(x) any(is.na(x)))))
```

In generating new radiocarbon chronologies, the following dates were excluded:
- 242 dates whose notes field said "rejected"
- 44 one-sided (infinite) dates
- 220 dates with zero values for age or error
This excluded a total of 460 of the original 5673 dates.
Another 363 are from dates that have not been run yet.


Join new chronologies to existing chronologies and get differences:
## SQL method
```{r}
temp <- newchron.all
colnames(temp) <- c("collectionunitid","analysisunitid","chrontype","age","ageolder_new","ageyounger_new")
```

```{r}
temp$collectionunitid <- as.numeric(temp$collectionunitid)
dbWriteTable(conn,"temp",temp,row.names = F,overwrite = T)
newchron <- dbGetQuery(conn,"select * from chronologies join temp on temp.collectionunitid = chronologies.collectionunitid;")
newchron <- newchron[,c("collectionunitid","analysisunitid","chronologyid","chrontype","ageboundolder","ageboundyounger","ageolder_new","ageyounger_new")]
colnames(newchron)[5:6] <- c("ageolder","ageyounger")
```

```{r}
dbWriteTable(conn,"temp",temp,row.names = F,overwrite = T)
newchron <- dbGetQuery(conn,"select * from sampleages join 
               (select * from temp join samples on temp.analysisunitid = samples.analysisunitid) 
                       as temp1 on sampleages.sampleid = temp1.sampleid;")
newchron <- newchron[,c("collectionunitid","analysisunitid","chronologyid","sampleid","age","chrontype","ageolder", "ageyounger","notes","ageolder_new","ageyounger_new")]
```

## API method
```{r}
require(neotoma2); source("functions.R")
chrons <- vector(mode = "list",length = length(unique(newchron.all$collectionunitid)))
i <- 0
I <- i + 1; J <- 100
while (I <= length(chrons)) {
  for (i in I:J) {
    x <- unique(newchron.all$collectionunitid)[i]
    temp <- get_from_tilia(meth = "getchronologiesbycollunitid", 
                                param = "collectionunitid", 
                                value = x)
    if (length(temp$data) > 0) {
                   chrons[[i]] <- data.frame(collectionunitid = as.numeric(x),temp$data)}
  }
  I <- i + 1; J <- min(c(length(chrons),(i + 100)))
}
chrons <- list.stack(chrons)
chrons <- distinct(subset(chrons,chrons$isdefault == TRUE)[,c("collectionunitid","chronologyid","chronologyname","ageboundolder","ageboundyounger","agetype","agemodel")])

compare_chrons <- inner_join(chrons,newchron.range,by = "collectionunitid")[,1:10]
colnames(compare_chrons) <-  c("collectionunitid","old.chronid","old.chronname","old.ageboundolder","old.ageboundyounger", "old.agetype","old.agemodel","new.agemodel","new.ageboundolder","new.ageboundyounger")

sampleages <- vector(mode = "list",length = length(unique(chrons$chronologyid)))
i <- 0
I <- i + 1; J <- 100
while (I <= length(sampleages)) {
  for (i in I:J) {
    x <- unique(chrons$chronologyid)[i]
    temp <- get_from_tilia(meth = "getsampleagesbychronid",
                           param = "chronologyid",
                           value = x)
    if (length(temp$data) > 0){
      sampleages[[i]] <- data.frame(chronologyid = as.numeric(x),temp$data)
    }
  }
  I <- i + 1; J <- min(c(nrow(sampleages),(i + 100)))
}

oldchron <- data.frame(dplyr::inner_join(chrons, distinct(list.stack(sampleages)), by = "chronologyid"))

newchron <- dplyr::inner_join(newchron.all,chrons,by = "collectionunitid",relationship = "many-to-many")
colnames(newchron) <- c("collectionunitid","analysisunitid","new.chrontype","new.age","ageolder_new","ageyounger_new","old.chronologyid","old.chronologyname","ageolder","ageyounger","old.agetype","old.agemodel")


sampleids <- vector(mode = "list",length = length(unique(oldchron$sampleid)))
i <- 0
I <- i + 1; J <- 100
while (I <= length(sampleids)) {
  for (i in I:J) {
    x <- unique(oldchron$sampleid)[i]
    temp <- get_from_tilia(meth = "getsampleparents",
                           param = "sampleid",
                           value = x)
    if (length(temp$data) > 0){
      sampleids[[i]] <- data.frame(sampleid = as.numeric(x),temp$data$analysisunitid)
    }
  }
  I <- i + 1; J <- min(c(nrow(sampleids),(i + 100)))
}
sampleids <- distinct(list.stack(sampleids)[,c("sampleid","analysisunitid")])
oldsampleages <- inner_join(oldchron,sampleids,by = "sampleid")

compare_sampleages <- inner_join(distinct(newchron.all[,1:6]),distinct(oldsampleages),
                                 by = c("analysisunitid","collectionunitid"))
colnames(compare_sampleages) <- c("collectionunitid","analysisunitid","new.chrontype","new.age", "ageolder_new","ageyounger_new","old.chronologyid","old.chronologyname","old.chron.ageolder","old.chron.ageyounger","old.agetype","old.agemodel","sampleid","old.sample.age","old.sample.ageyounger","old.sample.ageolder")
```


# either way, calculate differences
```{r}
newchron <- data.frame(dplyr::distinct(subset(newchron,apply(newchron[,c("ageolder","ageyounger","ageolder_new","ageyounger_new")],1,function(x) !any(is.na(x))))))
newchron$agediff <- abs(newchron$ageolder - newchron$ageyounger)
newchron$agediff_new <- abs(newchron$ageolder_new - newchron$ageyounger_new)
newchron$ageolder_diff <- newchron$ageolder - newchron$ageolder_new
newchron$ageyounger_diff <- newchron$ageyounger - newchron$ageyounger_new
```

#exploratory plots
```{r}
require(ggplot2)
```

```{r}
#range plot of age bounds
test <- subset(newchron.all,newchron.all$chronology.agemodel == "bounds" & newchron.all$source=="computed")[,c("sampleages.ageolder","sampleages.ageyounger")]
test <- test[order(test$sampleages.ageolder),]
test <- test[-which.max(test$sampleages.ageolder),] #drop Hajny Mammoth site outlier
ggplot(test, aes(y = 1:nrow(test))) +
  geom_linerange(aes(xmin = sampleages.ageyounger, xmax = sampleages.ageolder),
                 size = 1.5, alpha = 0.25) +
  scale_x_reverse() +
  geom_point(aes(x = sampleages.ageolder), color = "blue", size = 0.5) +
  geom_point(aes(x = sampleages.ageyounger), color = "red", size = 0.5) +
  geom_vline(xintercept = 11700)
```

```{r}
#scatter plot of older age vs age range
test <- subset(newchron.all,newchron.all$chronology.agemodel == "bounds")[,c("sampleages.ageolder","sampleages.ageyounger")]
test <- test[order(test$sampleages.ageolder),]
test <- test[-which.max(test$sampleages.ageolder),] #drop Hajny Mammoth site outlier
test <- subset(test,test$sampleages.ageolder <= 20000)
ggplot(test, aes(y = 1:nrow(test))) +
  geom_linerange(aes(xmin = sampleages.ageyounger, xmax = sampleages.ageolder),
                 size = 1.5, alpha = 0.25) +
  scale_x_reverse(minor_breaks = seq(20000,0,by=-1000)) +
  geom_point(aes(x = sampleages.ageolder), color = "blue", size = 0.5) +
  geom_point(aes(x = sampleages.ageyounger), color = "red", size = 0.5) +
  geom_vline(xintercept = 11700)
```
```{r}
#range plot of age bounds, last 20ka
test <- subset(newchron.all,newchron.all$chronology.agemodel == "bounds")[,c("sampleages.ageolder","sampleages.ageyounger")]
test <- test[order(test$sampleages.ageolder),]
test <- test[-which.max(test$sampleages.ageolder),] #drop Hajny Mammoth site outlier
ggplot(test,aes(x = sampleages.ageolder, y = sampleages.ageolder - sampleages.ageyounger)) +
  geom_point() + scale_x_reverse() + labs(x = "older age boundary", y = "age range") +
  geom_vline(xintercept = 11700)
```

```{r}
newchron.bounds <- subset(newchron,newchron$new.chrontype == "bounds")
test <- subset(newchron.bounds,newchron.bounds$agediff <= 5000&newchron.bounds$agediff_new <= 5000)
ggplot(reshape::melt(test[,c("agediff","agediff_new")]), 
       aes(x = value, fill = rev(variable), color = rev(variable))) +
  scale_color_discrete(name = "",labels = c("new chronology","previous chronology")) +
  ggtitle(label="Analysis unit age ranges (older - younger)") + 
  xlab("age range (cal yr)") + ylab("density") +
#  geom_histogram(color = "grey30") 
  geom_freqpoly(bins = 20)
```

```{r}
newchron.bounds <- subset(newchron,newchron$new.chrontype == "bounds")
test <- subset(newchron.bounds,newchron.bounds$agediff_new <= 20000)
test$meanage <- apply(test[,c("ageolder_new","ageyounger_new")],1,mean)
test$interval <- apply(test,1,function(x) {
  if (x["meanage"] >= 11700) {return("Pleistocene")} else {return("Holocene")} 
})
ggplot(test[,c("interval","agediff_new")], aes(x = agediff_new/2)) +
  ggtitle("Age uncertainty with variable bin size") +  xlab("age uncertainty (+/-)") + ylab("density") +
#  geom_histogram(breaks = c(0,200,400,600,1200,2500,5000,10000), color="grey20",fill="steelblue")
#  geom_histogram(breaks = seq(0,10000,500),color="grey20",fill="steelblue")
  geom_histogram(breaks = c(0,200,400,600,1000,1500,2500,5000,10000),color="grey20",fill="steelblue")
```

```{r}
newchron.bounds <- subset(newchron,newchron$new.chrontype == "bounds")
test <- subset(newchron.bounds,newchron.bounds$agediff_new <= 20000)
test$meanage <- apply(test[,c("ageolder_new","ageyounger_new")],1,mean)
test$interval <- apply(test,1,function(x) {
  if (x["meanage"] >= 11700) {return("Pleistocene")} else {return("Holocene")} 
})
ggplot(test[,c("interval","agediff_new")], aes(x = agediff_new/2, fill = interval)) +
  ggtitle("Age uncertainty with variable bin size") +  xlab("age uncertainty (+/-)") + ylab("density") +
#  geom_histogram(breaks = c(0,200,400,600,1200,2500,5000,10000), color="grey20",fill="steelblue")
#  geom_histogram(position = "stack", breaks = seq(0,10000,500))
  geom_histogram(position = "stack",breaks = c(0,200,400,600,1000,1500,2500,5000,10000),color="grey20")
```
```{r}
newchron_sites_pleistocene <- neotoma2::filter(sitelist,
                   siteid %in% unique(subset(alldates,alldates$collectionunitid %in% 
                       subset(newchron.all,newchron.all$sampleages.age >= 11700)$collectionunitid))$siteid)
newchron_sites_holocene <- neotoma2::filter(sitelist,
                   siteid %in% unique(subset(alldates,alldates$collectionunitid %in% 
                       subset(newchron.all,newchron.all$sampleages.age < 11700)$collectionunitid))$siteid)

require(leaflet)
leaflet() %>% addTiles() %>% 
  addCircleMarkers(data = as.data.frame(newchron_sites_holocene), 
                   radius = 1, popup = ~ sitename, color = "orange") %>% 
  addCircleMarkers(data = as.data.frame(newchron_sites_pleistocene), 
                   radius = 1, popup = ~ sitename, color = "purple") 
```

```{r}
newchron_event <- subset(newchron,newchron$new.chrontype=="event")
newchron_event$agebin <- cut(newchron_event$new.age,breaks = quantile(newchron_event$new.age,probs = seq(0,1,0.05)))
levels(newchron_event$agebin) <- rev(viridis::viridis(n = 20))

newchron_sites <- neotoma2::filter(sitelist,
                   siteid %in% unique(subset(alldates,alldates$collectionunitid %in% 
                       newchron.bounds$collectionunitid)$siteid))
temp <- data.frame(apply(getids(newchron_sites),1:2,as.numeric))
colnames(temp)[2] <- "collectionunitid"
temp <- inner_join(temp,newchron_event[,c("collectionunitid","analysisunitid","new.age","agebin")],relationship = "many-to-many")
temp2 <- as.data.frame(newchron_sites)[,c("siteid","lat","long")]
temp2$siteid <- as.numeric(temp2$siteid)
temp <- inner_join(temp,temp2)
newchron_sites_event <- dplyr::distinct(temp[,c("new.age","agebin","lat","long")])

leaflet() %>% addTiles() %>% 
  addCircleMarkers(data = newchron_sites_event,
     color = newchron_sites_event$agebin, radius = 2)
```

```{r}
newchron.bounds$rangebin <- cut(newchron.bounds$agediff_new,breaks = quantile(newchron.bounds$agediff_new,probs = seq(0,1,0.05)))
levels(newchron.bounds$rangebin) <- rev(viridis::viridis(n = 20))

temp <- data.frame(apply(getids(newchron_sites),1:2,as.numeric))
colnames(temp)[2] <- "collectionunitid"
temp <- inner_join(temp,newchron.bounds[,c("collectionunitid","analysisunitid","agediff_new","rangebin")],relationship = "many-to-many")
temp <- inner_join(temp,temp2)
temp <- inner_join(temp,newchron_event[,c("analysisunitid","agebin")])
newchron_sites_bounds <- dplyr::distinct(temp[,c("agediff_new","agebin","lat","long")])
newchron_sites_bounds <- subset(newchron_sites_bounds,newchron_sites_bounds$agediff_new < 10000)
newchron_sites_bounds <- newchron_sites_bounds[rev(order(newchron_sites_bounds$agediff_new)),]

leaflet() %>% addTiles() %>% 
  addCircleMarkers(data = newchron_sites_bounds, opacity = 0.2,
     radius = 12*(newchron_sites_bounds$agediff_new/max(newchron_sites_bounds$agediff_new)),
     color = newchron_sites_bounds$agebin)
```





```{r}
test <- subset(singleAU_uncal,singleAU_uncal$collectionunitid %in% newchron$collectionunitid)
inner_join(test,newchron,by = join_by(collectionunitid)) -> temp
dplyr::distinct(temp[,c("siteid","sitename","collectionunitid","analysisunitid.x","datasetid","chrontype","ageolder","ageyounger","ageolder_new","ageyounger_new","agediff","agediff_new","ageolder_diff","ageyounger_diff")]) -> temp
test <- as.data.frame(by(test,test$collectionunitid,function(x) length(unique(x$sampleid))))
as.numeric(rownames(test)) -> test$collectionunitid
temp <- inner_join(temp,test)
temp$x_cat <- as.factor(sapply(temp$x,function(x) if (x == 1) {return(1)} else if (1 < x & x < 6) {return(2)} else if (x >= 6) {return(3)}))
temp$ageshift <- temp$agediff_new - temp$agediff
datecount <- reshape::melt(temp[,c("chrontype","agediff_new","x_cat")])[,c("chrontype","x_cat","value")]
datecount_test <- ggplot(datecount,aes(x = value, color = x_cat, linetype = chrontype)) +
  xlim(0,10000) +
  #scale_x_continuous(trans = 'log10') + 
  scale_color_discrete(name = "Number of dates",labels = c("1","2-5","6+")) +
  scale_linetype_discrete(name = "Type of chronology",labels = c("bounds","event")) +
  ggtitle("Comparison of chronology types by date count") +  xlab("age range (cal YBP)") + ylab("number of collections") +
  geom_freqpoly()
```


```{r}
newchron.event <- subset(newchron, newchron$chrontype == "event")
ggplot(reshape::melt(newchron.event[,c("agediff","agediff_new")]), 
       aes(x = value, color = variable)) +
  xlim(0,10000) +
  #scale_x_continuous(trans = 'log10') + 
  scale_color_discrete(name = "Sample age range",labels = c("previous default","new (this project)")) +
  ggtitle("Age ranges (older - younger)") +  xlab("age range") + ylab("density") +
  geom_freqpoly()
```


```{r}
temp <- subset(newchron,newchron$chrontype == "bounds")
temp <- data.frame(older = temp$ageolder_diff/temp$ageolder_new,
                   younger = temp$ageyounger_diff/temp$ageyounger_new)
data <- reshape::melt(temp)
ggplot(data, aes(x = value, fill = variable)) +
  ggtitle("Age limit shifts ") +  
#  scale_y_continuous(trans = "log10") +
  xlim(-1,1) +
  xlab("change in estimate (%)") + ylab("count") +
  geom_histogram(bins = 30)
```
```{r}
data <- reshape::melt(newchron[,c("age","ageolder_diff","ageyounger_diff")], id.vars = 1)
ggplot(data,aes(x = age,y = value,color = variable)) +
  ggtitle("Age limit shifts ") +  
  ylim(-10000,10000) +
  xlab("median age") + ylab("age shift") +
  geom_point()
```

single date plot
```{r}
collid <- 4483
data <- subset(singleAU_uncal,singleAU_uncal$collectionunitid == collid)
oxcalResult <- unitDates(data)
temp <- rbind(oxcalResult$`114929[Geochron]`$posterior_probabilities,
              oxcalResult$`114930[Geochron]`$posterior_probabilities,
              oxcalResult$`114931[Geochron]`$posterior_probabilities)
temp$dates <- temp$dates - 1950
temp$sample <- c(rep("114929",nrow(oxcalResult$`114929[Geochron]`$posterior_probabilities)),
               rep("114930",nrow(oxcalResult$`114930[Geochron]`$posterior_probabilities)),
               rep("114931",nrow(oxcalResult$`114931[Geochron]`$posterior_probabilities)))
uncal <- data[,c("sampleid","age")]
uncal$age <- uncal$age * -1
uncal$error <- apply(data[,c("errorolder","erroryounger")],1,mean)
CrystalBallCave <- ggplot(data = temp, aes(x = dates,y = probabilities, color = sample)) + 
  scale_color_brewer(palette = "Set1") +
  ggtitle(paste("Radiocarbon dates from ",data$sitename[1],
                " (site id ",data$siteid[1],")",sep = "")) +
  annotate(geom="rect",xmin = -23000, xmax = -10000, ymin = -Inf, ymax = Inf, fill = "black", alpha = 0.1) +
  annotate(geom="rect",xmin = -25252, xmax = -18242, ymin = -Inf, ymax = Inf, fill = "white", alpha = 0.4) + 
  stat_function(data = uncal, aes(x = age, y = error, color = sampleid), fun = dnorm, 
                args = list(mean = uncal$age[1], sd = uncal$error[1]), 
                color = brewer.pal(n = 6,name = "Set1")[1], linetype = "dashed") +
  stat_function(data = uncal, aes(x = age, y = error, color = sampleid), fun = dnorm, 
                args = list(mean = uncal$age[2], sd = uncal$error[2]), 
                color = brewer.pal(n = 6,name = "Set1")[2], linetype = "dashed") +
  stat_function(data = uncal, aes(x = age, y = error, color = sampleid), fun = dnorm, 
                args = list(mean = uncal$age[3], sd = uncal$error[3]), 
                color = brewer.pal(n = 6,name = "Set1")[3], linetype = "dashed") +
  geom_vline(xintercept = c(-23000,-10000),linetype = "dashed",linewidth = 0.1) +
  geom_line() + theme(plot.title = element_text(hjust = 1)) +
  geom_vline(xintercept = c(-20712,-22407,-22567),color = brewer.pal(n = 6,name = "Set1")[1:3], 
             linewidth = 0.5) +
  geom_vline(xintercept = c(-25252,-18242), linewidth = 0.1) +
  annotate("text",x = -15000, y = 0.0003,label = "Old chronology") +
  annotate("text",x = -25000, y = 0.0003,label = "New chronology")
  
```

```{r}
CrystalBallCave_simple <- ggplot(data = temp, aes(x = dates,y = probabilities, color = sample)) + 
  scale_color_brewer(palette = "Set1") +
  ggtitle(paste("Radiocarbon dates from ",data$sitename[1],
                " (site id ",data$siteid[1],")",sep = "")) +
  geom_line() + theme(plot.title = element_text(hjust = 1)) +
  stat_function(data = uncal, aes(x = age, y = error, color = sampleid), fun = dnorm, 
                args = list(mean = uncal$age[1], sd = uncal$error[1]), 
                color = brewer.pal(n = 6,name = "Set1")[1], linetype = "dashed") +
  stat_function(data = uncal, aes(x = age, y = error, color = sampleid), fun = dnorm, 
                args = list(mean = uncal$age[2], sd = uncal$error[2]), 
                color = brewer.pal(n = 6,name = "Set1")[2], linetype = "dashed") +
  stat_function(data = uncal, aes(x = age, y = error, color = sampleid), fun = dnorm, 
                args = list(mean = uncal$age[3], sd = uncal$error[3]), 
                color = brewer.pal(n = 6,name = "Set1")[3], linetype = "dashed") 
```

statistical exploration
```{r}
#comparing old vs new age ranges
compare_sampleages$oldage_diff <- compare_sampleages$old.sample.ageolder - compare_sampleages$old.sample.ageyounger
compare_sampleages$newage_diff <- compare_sampleages$ageolder_new - compare_sampleages$ageyounger_new
by(compare_sampleages, compare_sampleages$new.chrontype, function(x) summary(x$oldage_diff - x$newage_diff))
```


```{r}
by(compare_sampleages,compare_sampleages$new.chrontype, function(x) {
  return(rbind(summary(x$old.sample.ageolder - x$ageolder_new),
  summary(x$old.sample.ageyounger - x$ageyounger_new)))
})
```

```{r}
by(compare_chrons,compare_chrons$new.agemodel,function(x) {
  return(rbind(summary(x$old.ageboundolder-x$new.ageboundolder),
  summary(x$old.ageboundyounger-x$new.ageboundyounger)))
})
```

