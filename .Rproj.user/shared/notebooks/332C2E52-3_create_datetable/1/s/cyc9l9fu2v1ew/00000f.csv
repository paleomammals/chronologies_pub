"0","##use Tilia calls to assemble list of collection units"
"0","require(httr);require(jsonlite);require(dplyr);require(rlist)"
"0","if (exists(""collections.ti"")) {if (checkRecent(collections.ti) == F) {rm(collections.ti)}}"
"0","if (!exists(""collections.ti"")) {"
"0","  colls <- unique(vert_and_chron$collectionunitid)"
"0","  collections.ti <- vector(mode = ""list"",length = length(colls))"
"0","  print(paste0(c(""Downloading data for"",length(colls),""collections...""),collapse = "" ""))"
"0","  I <- 1; J <- 100"
"0","  while (I <= length(colls)) {"
"0","    for (i in I:J) {"
"0","      temp <- get_from_tilia(values = colls[i], "
"0","                             params = ""collectionunitid"", "
"0","                             meth = ""getcollunitbyid"")$data"
"0","      if (length(temp) == 0) { "
"0","        temp <- data.frame(collectionunitid = NA,handle = NA,siteid = NA,colltypeid = NA,"
"0","                           depenvtid = NA,collunitname = NA,colldate = NA,colldevice = NA,"
"0","                           gpslatitude = NA,gpslongitude = NA,gpsaltitude = NA,gpserror = NA,"
"0","                           waterdepth = NA,substrateid = NA,slopeaspect = NA,slopeangle = NA,"
"0","                           location = NA,notes = NA) }"
"0","      collections.ti[[i]] <- data.frame(datasetid = colls[i], temp)"
"0","    }"
"0","    save(collections.ti,file = here(""data/collections_ti_temp.RData""))"
"0","    if (i %% 500 == 0) {print(paste0(c(i,""downloaded""),collapse = "" ""))}"
"0","    I <- i + 1; J <- i + 100"
"0","    if (J > length(colls)) {J <- length(colls)} "
"0","  }"
"0","  print(paste0(c(""Done."",length(which(sapply(collections.ti,function(x) is.na(x$collectionunitid[1])))),""of"",length(collections.ti),""failed.""),collapse = "" ""))"
"0","}"
"1","[1]"
"1"," ""Downloading data for 2557 collections..."""
"1","
"
"1","[1]"
"1"," ""500 downloaded"""
"1","
"
"1","[1]"
"1"," ""1000 downloaded"""
"1","
"
"1","[1]"
"1"," ""1500 downloaded"""
"1","
"
"1","[1]"
"1"," ""2000 downloaded"""
"1","
"
"1","[1]"
"1"," ""2500 downloaded"""
"1","
"
"1","[1]"
"1"," ""Done. 1 of 2557 failed."""
"1","
"
"0","collections.ti <- distinct(list.stack(collections.ti)[,c(""collectionunitid"",""depenvtid"")])"
