---
title: "Non-automatable chronologies"
author: "Val Syverson"
---

The collections that contain both uncalibrated 14C dates and other types of dates (calibrated 14C, uranium, dendrochronological, obsidian hydration, thermoluminescence, etc.) have to be computed using the OxCal web interface, because the oxcAAR package can't handle them. This notebook contains a script to generate code blocks that can be pasted into the web interface and run; instructions for running it and downloading the results in .csv format; and more scripts that parse the .csv files into the same format as the results generated by the previous notebook and save them into the appropriate directories.

# load functions and libraries
```{r}
if ("here" %in% installed.packages()) {require(here)} else {install.packages("here"); require(here)}
i_am("final_scripts/4_manual_chronologies.Rmd")
source(here("final_scripts/functions/4_manual_chronologies_functions.R"))
```

1. Generate the OxCal code blocks
# Read in dates, select appropriate category
```{r}
dates <- alldates <- read.csv(here("data/alldates.csv"))
dates <- split(dates,dates$category)
mixed <- dates$`3`
mixed <- split(mixed,mixed$collectionunitid)
done <- as.numeric(unlist(sapply(dir(here("outputs/sampleages")),
                                 function(x) return(strsplit(x,".csv")))))
mixed <- mixed[!names(mixed) %in% done]

```

# Generate the OxCal code files and save them to disk
```{r}
codeblocks <- sapply(mixed,makeOxcalCode)
here()
for (i in 1:length(codeblocks)){
  filename <- paste0(c(here("final_scripts/oxcalscripts/oxcode"),names(codeblocks[i]),".txt"),
                     collapse = "")
  print(filename)
  write(codeblocks[[i]],file = filename)
}
# These will be named only with the collection number, not the collection name. The existing files in that folder have had the collection name manually appended as a memory aid.
```

2. Run the code blocks in the OxCal web interface

For each of these files, paste the contents into a code window on the OxCal website (https://c14.arch.ox.ac.uk/oxcal/OxCal.html) and run the model. (This may take some time.)
When it completes, with the "Table" window focused, choose File > Export to bring up the "Report" window. Click "Save", then "Download" to get the results formatted as a .csv file with the name you chose when you ran it. 
The next section assumes you saved these .csv files in the folder "outputs/oxcalDownloads_new".

3. Format the .csv output to match the other results
# read in the output tables
```{r}
temp <- vector(mode = "list", 
                              length = length(dir(here("outputs/oxcalDownloads_new"))))
for (i in 1:length(temp)) {
  temp[[i]] <- read.csv(file = paste0(c(here("outputs/oxcalDownloads_new/"), "/",
                              dir(here("outputs/oxcalDownloads_new/"))[i]),collapse = ""))
  names(temp)[i] <- gsub(".csv","",dir(here("outputs/oxcalDownloads_new/"))[i])
}
# filter out already-processed results
temp <- temp[sapply(names(mixed), function(x) any(grepl(x,names(temp))))]
web.results <- vector(mode = "list", length = length(temp))
names(web.results) <- names(temp)
```

# parse the output tables
```{r}
# compute the appropriate quantiles from the probability density functions in the files you downloaded
for (i in which(sapply(web.results,length) == 1)){
  web.results[[i]] <- try(extractChronology.Table(temp[[i]],idtype = "geochronid"))
}
# clean up the names of the chroncontrols
for (i in 1:length(web.results)){
  web.results[[i]]$chroncontrols$geochronology.labnumber <- 
    gsub(", .*", "",web.results[[i]]$chroncontrols$geochronology.labnumber)
}
```

4. Save results
Finally, output the correctly formatted sample ages and chroncontrols into the same folders that contain the rest of the results. 
```{r}
for (i in 1:length(web.results)){
  filestring <- paste0(c(strsplit(names(web.results[i]),"-")[[1]][1],".csv"),collapse = "")
  write.csv(web.results[[i]]$sampleages,
            file = paste0(c(here("outputs/sampleages/"),
                            filestring),collapse = ""), row.names = F)
  write.csv(web.results[[i]]$chroncontrols,
            file = paste0(c(here("outputs/chroncontrols/"),
                            filestring),collapse = ""), row.names = F)
}
```

