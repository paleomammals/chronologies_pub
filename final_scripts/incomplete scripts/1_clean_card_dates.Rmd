---
title: "R Notebook"
#output: html_notebook
author: "Val Syverson"
---

This process is NOT automated; a number of the steps involve export and manual cleaning (e.g. using OpenRefine).

Additionally, it requires a copy of the latest snapshot of NeotomaDB running on a local installation of PostgreSQL. You will need to adjust the parameters in the script "postgresConnect.R" to suit your local installation conditions.

```{r}
require(stringr); require(dplyr); require(rlist)
require(here); i_am("1_clean_card_dates.Rmd")
source(here("../scripts/postgresConnect.R"))
```
 

# Assemble all CARD dates and write to local Postgres db

Downloaded files from CARD should first be extracted to the directory "workflow/data/card_data/raw".

```{r}
card <- data.frame()
temp <- list.files("workflow/data/card_data/raw")
for (i in 1:length(temp)){
  tempfile <- read.csv(paste0("workflow/card_data/raw/",temp[i],collapse = ""),sep = "\t",fileEncoding = "UTF-16")
  card <- rbind(card,tempfile)
}
colnames(card) <- sub("\\.","_",sub("\\.","_",sub("\\.\\.",".",colnames(card))))
colnames(card)[8] <- "Elevation_m_ASL"
colnames(card)[19] <- "Delta_13c_per_mil"
colnames(card) <- str_to_lower(colnames(card))
dbSendQuery(conn,"drop table card;")
dbWriteTable(conn,"card",card,row.names = FALSE)
write.csv(card,"card_data/card.csv",row.names = FALSE)
```

# Parse out different subsets of the data

## Dates already present in Neotoma

### Match by lab number
```{r}


temp <- distinct(dbGetQuery(conn,
  "select siteid,collectionunits.collectionunitid,analysisunitid,sampleid,geochronid,labnumber,temp3.notes from collectionunits join 
    (select collectionunitid,analysisunits.analysisunitid,sampleid,geochronid,labnumber,temp2.notes from analysisunits join 
      (select analysisunitid,samples.sampleid,geochronid,temp1.labnumber,temp1.notes from samples join 
        (select * from geochronology where notes like '%CARD%') 
      as temp1 on samples.sampleid=temp1.sampleid) 
    as temp2 on analysisunits.analysisunitid=temp2.analysisunitid) 
  as temp3 on collectionunits.collectionunitid=temp3.collectionunitid;"))
card_match <- card; rm(card)
test <- merge(card_match,temp,by.x = "lab_number",by.y="labnumber",all = T)
```

```{r}
toCheck <- which(test$sampleid %in% temp[which(!temp$labnumber %in% card_match$lab_number),"sampleid"])
test[toCheck[i],]
```

```{r}
test1 <- test[match(card_match$lab_number,test$lab_number),]
for (i in 1:nrow(test1)) print(identical(test1[,i],card_match[,i]))
card_match <- test[match(card_match$lab_number,test$lab_number),1:36]
rm(test1,test)

#separate out  and remove fully matched dates
write.csv(subset(card_match,!is.na(card_match$sampleid)),file="card_data/sample_matched.csv",row.names=F)
card_match <- card_match[which(is.na(card_match$sampleid)), !colnames(card_match) %in% c("collectionunitid","analysisunitid","sampleid","geochronid")]
```

```{r}

```

